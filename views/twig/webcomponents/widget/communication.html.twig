{% apply spaceless %}
    <ff-communication
        {% for key, value in oViewConf.getCommunicationParams() %}
            {{ key }}="{{ value|escape }}"
        {% endfor %}
    >
    </ff-communication>
{% endapply %}


<script>
    {% if oViewConf.getTrackingSettings() %}
        const ffTrackingSettings = JSON.parse('{{ oViewConf.getTrackingSettings()|json_encode }}');
    {% else %}
        const ffTrackingSettings = {};
    {% endif %}

    document.addEventListener('ffCommunicationReady', ({ factfinder, searchImmediate }) => {
        const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
            const cookieData = cookie.split('=');
            const [key, value] = cookieData;
            acc[key] = value;

            return acc;
        }, {});

        if (cookies['ff_user_id']) {
            factfinder.communication.sessionManager.setLoginData(cookies['ff_user_id']);

            if (cookies['ff_has_just_logged_in']) {
                factfinder.communication.Tracking.loginWithConfig();
            }
        } else {
            factfinder.communication.sessionManager.clearLoginData();

            if (cookies['ff_has_just_logged_out']) {
                factfinder.communication.sessionManager.clearAllSessionData();
            }

            if ('{{ oViewConf.useSidAsUserId()|escape("js") }}') {
                factfinder.communication.sessionManager.setLoginData(localStorage.getItem('ff_sid'));
            }
        }

        if ('{{ oViewConf.getSearchImmediate()|escape("js") }}') {
            searchImmediate();
        }
    });
</script>
